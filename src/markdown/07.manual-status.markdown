# Nicepay API 2.0 - ê²°ì œì¡°íšŒ API
- https://developers.nicepay.co.kr/manual-status.php

í•´ë‹¹ ì„œë¹„ìŠ¤ëŠ” ê±°ë˜ì˜ TIDë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê²°ì œ ìŠ¹ì¸ ë˜ëŠ” ì·¨ì†Œ ì—¬ë¶€ ë“± í˜„ì¬ ê²°ì œ ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.

## ğŸ“Œ ì£¼ìš” ê°œìš”
- ì´ ë¬¸ì„œëŠ” ë‚˜ì´ìŠ¤í˜ì´ ê±°ë˜ìƒíƒœì¡°íšŒ API ì‚¬ìš©ë²•ê³¼ ì‹¤ì œ êµ¬í˜„ ì˜ˆì œë¥¼ ì œê³µí•©ë‹ˆë‹¤.
- íŠ¹ì • ê±°ë˜ì— ëŒ€í•œ ê²°ì œ ìŠ¹ì¸ ë˜ëŠ” ì·¨ì†Œ ìƒíƒœë¥¼ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥
- ê°€ìƒê³„ì¢Œ(TID)ì˜ ê²½ìš°, ì…ê¸ˆì´ ì™„ë£Œë˜ì–´ì•¼ ìŠ¹ì¸ ì²˜ë¦¬ ìƒíƒœê°€ ì „ë‹¬ë©ë‹ˆë‹¤
- ê²°ì œ(ìŠ¹ì¸) ë˜ëŠ” ì·¨ì†Œ ìš”ì²­ ì´í›„ì—, ì‹œìŠ¤í…œì´ ì²˜ë¦¬ëœ ê²°ê³¼ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ í™œìš©

## API ì •ë³´
- **URL**: `https://webapi.nicepay.co.kr/webapi/inquery/trans_status.jsp`
- **Method**: POST
- **Content-Type**: `application/x-www-form-urlencoded`
- **Charset**: EUC-KR

## âœ… ìš”ì²­ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | ê¸¸ì´ | í•„ìˆ˜ | ì„¤ëª… |
|---------|------|------|------|
| TID     | 30B  | Y | ê±°ë˜ë²ˆí˜¸ |
| MID     | 10B  | Y | ìƒì ì•„ì´ë”” |
| EdiDate | 14B  | Y | ì „ë¬¸ìƒì„±ì¼ì‹œ (yyyyMMddHHmmss) |
| SignData| 256B | Y | SHA-256 í•´ì‹œê°’ (TID + MID + EdiDate + MerchantKey) |
| CharSet | 10B  |  | ì‘ë‹µ ì¸ì½”ë”© (euc-kr(default) / utf-8) |
| EdiType | 10B  |  | ì‘ë‹µì „ë¬¸ ìœ í˜• (JSON / KV) *KV:Key=value |

## âœ… ì‘ë‹µ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„°     | ê¸¸ì´ | í•„ìˆ˜ | ì„¤ëª… |
|------------|------|------|------|
| ResultCode | 4B   | Y | ê²°ê³¼ì½”ë“œ (0000: ì„±ê³µ / ê·¸ì™¸ ì‹¤íŒ¨) |
| ResultMsg  | 100B | Y | ê²°ê³¼ë©”ì‹œì§€ |
| TID        | 30B  | Y | ê±°ë˜ë²ˆí˜¸ |
| Status     | 1B   | Y | ê±°ë˜ìƒíƒœ (0: ìŠ¹ì¸ ìƒíƒœ, 1: ì·¨ì†Œ ìƒíƒœ, 9: ìŠ¹ì¸ ê±°ë˜ ì—†ìŒ) |
| AuthCode   | 30B  |  | ìŠ¹ì¸ë²ˆí˜¸ |
| AuthDate   | 12B  |  | ìŠ¹ì¸ì¼ì‹œ |

## ğŸ”„ ì²˜ë¦¬ íë¦„ ìš”ì•½

1. ê°€ë§¹ì ì´ TIDë¥¼ í¬í•¨í•˜ì—¬ ì¡°íšŒ API í˜¸ì¶œ
2. PGì‚¬(ë‚˜ì´ìŠ¤í˜ì´)ì—ì„œ í•´ë‹¹ ì‹œì¥ ê±°ë˜ ê²°ê³¼ ë°ì´í„° ì‘ë‹µ
3. ê°€ë§¹ì  ì„œë²„ì—ì„œ ì‘ë‹µ ì„œëª…(SignData/Signature) ê²€ì¦
4. `resultCode === '0000'`ì¼ ê²½ìš° ìƒíƒœ(`status`) í™•ì¸ í›„ í›„ì† ì²˜ë¦¬
5. ì˜ˆì™¸ ìƒíƒœ (ë¯¸ê²°ì œ, ì·¨ì†Œ, ì˜¤ë¥˜ ë“±)ì— ëŒ€í•œ ì˜ˆì™¸ ì²˜ë¦¬ ë¡œì§ ë°˜ì˜

## ğŸ“‚ êµ¬í˜„ ì˜ˆì œ (Pseudo-code)

### 1. Java/JSP êµ¬í˜„

```jsp
<%@ page contentType="text/html; charset=euc-kr"%>
<%@ page import="java.util.Date"%>
<%@ page import="java.util.HashMap"%>
<%@ page import="java.util.Iterator"%>
<%@ page import="java.io.PrintWriter"%>
<%@ page import="java.io.BufferedReader"%>
<%@ page import="java.io.InputStreamReader"%>
<%@ page import="java.net.URL"%>
<%@ page import="java.net.HttpURLConnection"%>
<%@ page import="java.text.SimpleDateFormat"%>
<%@ page import="java.security.MessageDigest"%>
<%@ page import="org.json.simple.JSONObject"%>
<%@ page import="org.json.simple.parser.JSONParser"%>
<%@ page import="org.apache.commons.codec.binary.Hex"%>

<%
request.setCharacterEncoding("euc-kr");
String transStatusURL = "https://webapi.nicepay.co.kr/webapi/inquery/trans_status.jsp";
String mid = ""; // ìƒì ì•„ì´ë””
String tid = ""; // ê±°ë˜ë²ˆí˜¸

// ì‘ë‹µ ê²°ê³¼ íŒŒë¼ë¯¸í„° ì´ˆê¸°í™”
String ResultCode = "";
String ResultMsg = "";
String TID = "";
String Status = "";
String resultJsonStr = "";

/*
****************************************************************************************
* <í•´ì‰¬ì•”í˜¸í™”> (ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”)
* SHA-256 í•´ì‰¬ì•”í˜¸í™”ëŠ” ê±°ë˜ ìœ„ë³€ì¡°ë¥¼ ë§‰ê¸°ìœ„í•œ ë°©ë²•ì…ë‹ˆë‹¤.
****************************************************************************************
*/
DataEncrypt sha256Enc = new DataEncrypt();
String merchantKey = "";
String ediDate = getyyyyMMddHHmmss();
String SignData = sha256Enc.encrypt(tid + mid + ediDate + merchantKey);

StringBuffer requestData = new StringBuffer();
requestData.append("TID=").append(tid).append("&");
requestData.append("MID=").append(mid).append("&");
requestData.append("EdiDate=").append(ediDate).append("&");
requestData.append("Charset=").append("euc-kr").append("&");
requestData.append("SignData=").append(SignData).append("&");

// API Call
resultJsonStr = connectToServer(requestData.toString(),transStatusURL);
HashMap resultData = new HashMap();
resultData = jsonStringToHashMap(resultJsonStr);

ResultCode = (String) resultData.get("ResultCode");
ResultMsg = (String) resultData.get("ResultMsg");
TID = (String) resultData.get("TID");
Status = (String) resultData.get("Status");
%>

<!DOCTYPE html>
<html>
<head>
<title>NICEPAY TRANSACTION_STATUS_RESULT(EUC-KR)</title>
<meta charset="euc-kr">
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=yes, target-densitydpi=medium-dpi" />
</head>
<body>
<div class="top">NICEPAY TRANSACTION_STATUS_RESULT(EUC-KR)</div>
<div class="conwrap">
<div class="tabletypea">
<table>
<colgroup>
<col width="150px" />
<col width="*">
</colgroup>
<tr>
<th><span>ResultCode</span></th>
<td><%=ResultCode%></td>
</tr>
<tr>
<th><span>ResultMsg</span></th>
<td><%=ResultMsg%></td>
</tr>
<tr>
<th><span>TID</span></th>
<td><%=TID%></td>
</tr>
<tr>
<th><span>Status</span></th>
<td><%=Status%></td>
</tr>
</table>
</div>
</div>
</body>
</html>

<%!
// ë‚ ì§œ í¬ë§· í•¨ìˆ˜
public final synchronized String getyyyyMMddHHmmss() {
    SimpleDateFormat yyyyMMddHHmmss = new SimpleDateFormat("yyyyMMddHHmmss");
    return yyyyMMddHHmmss.format(new Date());
}

// SHA-256 ì•”í˜¸í™” í´ë˜ìŠ¤
public class DataEncrypt {
    MessageDigest md;
    String strSRCData = "";
    String strENCData = "";
    String strOUTData = "";
    
    public DataEncrypt() {
    }
    
    public String encrypt(String strData) {
        String passACL = null;
        MessageDigest md = null;
        try {
            md = MessageDigest.getInstance("SHA-256");
            md.reset();
            md.update(strData.getBytes());
            byte[] raw = md.digest();
            passACL = encodeHex(raw);
        } catch (Exception e) {
            System.out.print("encryption error" + e.toString());
        }
        return passACL;
    }
    
    public String encodeHex(byte[] b) {
        char[] c = Hex.encodeHex(b);
        return new String(c);
    }
}

// API í˜¸ì¶œ í•¨ìˆ˜
public String connectToServer(String data, String reqUrl) throws Exception {
    HttpURLConnection conn = null;
    BufferedReader resultReader = null;
    PrintWriter pw = null;
    URL url = null;
    int statusCode = 0;
    StringBuffer recvBuffer = new StringBuffer();
    
    try {
        url = new URL(reqUrl);
        conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("POST");
        conn.setConnectTimeout(15000);
        conn.setReadTimeout(25000);
        conn.setDoOutput(true);
        
        pw = new PrintWriter(conn.getOutputStream());
        pw.write(data);
        pw.flush();
        
        statusCode = conn.getResponseCode();
        resultReader = new BufferedReader(new InputStreamReader(conn.getInputStream(), "euc-kr"));
        for (String temp; (temp = resultReader.readLine()) != null;) {
            recvBuffer.append(temp).append("\n");
        }
        
        if (!(statusCode == HttpURLConnection.HTTP_OK)) {
            throw new Exception();
        }
        return recvBuffer.toString().trim();
    } catch (Exception e) {
        return "9999";
    } finally {
        recvBuffer.setLength(0);
        try {
            if (resultReader != null) {
                resultReader.close();
            }
        } catch (Exception ex) {
            resultReader = null;
        }
        try {
            if (pw != null) {
                pw.close();
            }
        } catch (Exception ex) {
            pw = null;
        }
        try {
            if (conn != null) {
                conn.disconnect();
            }
        } catch (Exception ex) {
            conn = null;
        }
    }
}

// JSON íŒŒì‹± í•¨ìˆ˜
private static HashMap jsonStringToHashMap(String str) throws Exception {
    HashMap dataMap = new HashMap();
    JSONParser parser = new JSONParser();
    try {
        Object obj = parser.parse(str);
        JSONObject jsonObject = (JSONObject) obj;
        Iterator<String> keyStr = jsonObject.keySet().iterator();
        while (keyStr.hasNext()) {
            String key = keyStr.next();
            Object value = jsonObject.get(key);
            dataMap.put(key, value);
        }
    } catch (Exception e) {
    }
    return dataMap;
}
%>
```

### 2. PHP êµ¬í˜„

```php
<?php
header("Content-Type:text/html; charset=euc-kr;");

$tid = ""; // ê±°ë˜ ID
$mid = ""; // ìƒì  ì•„ì´ë””
$charSet = ""; // ì‘ë‹µ ì¸ì½”ë”©
$response = "";

/*
****************************************************************************************
* <í•´ì‰¬ì•”í˜¸í™”> (ìˆ˜ì •í•˜ì§€ ë§ˆì„¸ìš”)
* SHA-256 í•´ì‰¬ì•”í˜¸í™”ëŠ” ê±°ë˜ ìœ„ë³€ì¡°ë¥¼ ë§‰ê¸°ìœ„í•œ ë°©ë²•ì…ë‹ˆë‹¤.
****************************************************************************************
*/
$ediDate = date("YmdHis");
$merchantKey = ""; // ìƒì í‚¤
$postURL = "https://webapi.nicepay.co.kr/webapi/inquery/trans_status.jsp";
$signData = bin2hex(hash('sha256', $tid . $mid . $ediDate . $merchantKey, true));

$data = Array(
    'TID' => $tid,
    'MID' => $mid,
    'CharSet' => $charSet,
    'EdiDate' => $ediDate,
    'SignData' => $signData
);

$response = reqPost($data, $postURL); //ìŠ¹ì¸ í˜¸ì¶œ
jsonRespDump($response); //response json dump example

// API CALL foreach ì˜ˆì‹œ
function jsonRespDump($resp){
    $resp_utf = iconv("EUC-KR", "UTF-8", $resp);
    $respArr = json_decode($resp_utf);
    foreach ( $respArr as $key => $value ){
        echo "$key=". iconv("UTF-8", "EUC-KR", $value)."<br>";
    }
}

//Post api call
function reqPost(Array $data, $url){
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 15); //connection timeout 15
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
    curl_setopt($ch, CURLOPT_POSTFIELDS, http_build_query($data)); //POST data
    curl_setopt($ch, CURLOPT_POST, true);
    $response = curl_exec($ch);
    curl_close($ch);
    return $response;
}
?>
```

### 3. C# (ASP.NET) êµ¬í˜„

```csharp
using System;
using System.Web.UI;
using System.Security.Cryptography;
using System.Text;
using System.Net;
using System.IO;
using System.Web;

public partial class statusResponse : System.Web.UI.Page
{
    protected System.Web.UI.WebControls.Literal Res_ResultCode;
    protected System.Web.UI.WebControls.Literal Res_ResultMsg;
    protected System.Web.UI.WebControls.Literal Res_Status;
    protected System.Web.UI.WebControls.Literal Res_TID;
    
    protected string tid;
    protected string signData;
    protected string ediDate;
    protected string merchantKey;
    protected string mid;
    protected string charSet;
    protected string postURL;
    
    protected void Page_Load(object sender, EventArgs e)
    {
        if (!Page.IsPostBack)
        {
            resultData();
        }
    }
    
    protected void resultData()
    {
        merchantKey = "";
        tid = "";
        mid = "";
        charSet = "";
        ediDate = String.Format("{0:yyyyMMddHHmmss}", DateTime.Now);
        signData = stringToSHA256(tid + mid + ediDate + merchantKey);
        postURL = "https://webapi.nicepay.co.kr/webapi/inquery/trans_status.jsp";
        
        var postData = "TID=" + Uri.EscapeDataString(tid);
        postData += "&MID=" + Uri.EscapeDataString(mid);
        postData += "&EdiDate=" + ediDate;
        postData += "&CharSet=" + Uri.EscapeDataString(charSet);
        postData += "&EdiType=" + "KV";
        postData += "&SignData=" + Uri.EscapeDataString(signData);
        
        //API Call
        var result = apiRequest(postURL, postData);
        
        //Stream encode
        var queryStr = streamEncode(result);
        
        //ParseQueryString
        var response = HttpUtility.ParseQueryString(queryStr);
        
        //Response data
        Res_ResultCode.Text = response["ResultCode"];
        Res_ResultMsg.Text = response["ResultMsg"];
        Res_Status.Text = response["Status"];
        Res_TID.Text = response["TID"];
    }
    
    public String stringToSHA256(String plain)
    {
        SHA256Managed SHA256 = new SHA256Managed();
        String getHashString = BitConverter.ToString(SHA256.ComputeHash(Encoding.UTF8.GetBytes(plain))).ToLower();
        return getHashString.Replace("-", "");
    }
    
    public HttpWebResponse apiRequest(String url, String postData)
    {
        var request = (HttpWebRequest)WebRequest.Create(url);
        System.Text.Encoding euckr = System.Text.Encoding.GetEncoding(51949);
        var data = euckr.GetBytes(postData);
        
        request.Method = "POST";
        request.ContentType = "application/x-www-form-urlencoded";
        request.ContentLength = data.Length;
        
        using (var stream = request.GetRequestStream())
        {
            stream.Write(data, 0, data.Length);
        }
        
        var result = (HttpWebResponse)request.GetResponse();
        return result;
    }
    
    public String streamEncode(HttpWebResponse result)
    {
        Stream ReceiveStream = result.GetResponseStream();
        Encoding encode = System.Text.Encoding.GetEncoding(51949);
        StreamReader sr = new StreamReader(ReceiveStream, encode);
        Char[] read = new Char[8096];
        int count = sr.Read(read, 0, 8096);
        Char[] chTemp = new Char[count];
        for (int i = 0; i < count; ++i)
            chTemp[i] = read[i];
        Byte[] buffer = encode.GetBytes(chTemp);
        String strOut = encode.GetString(buffer);
        return strOut;
    }
}
```

## âš ï¸ ì¤‘ìš” ì‚¬í•­

### ë³´ì•ˆ
- **SignData**: ê±°ë˜ ìœ„ë³€ì¡° ë°©ì§€ë¥¼ ìœ„í•´ ë°˜ë“œì‹œ SHA-256 í•´ì‹œ ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
- **MerchantKey**: ìƒì í‚¤ëŠ” ì ˆëŒ€ ë…¸ì¶œë˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.

### ì¸ì½”ë”©
- API ìš”ì²­/ì‘ë‹µì€ ëª¨ë‘ **EUC-KR** ì¸ì½”ë”©ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ì‘ë‹µ ë°ì´í„°ë¥¼ UTF-8ë¡œ ë³€í™˜í•  ë•ŒëŠ” ì ì ˆí•œ ì¸ì½”ë”© ë³€í™˜ì´ í•„ìš”í•©ë‹ˆë‹¤.

### íƒ€ì„ì•„ì›ƒ
- ì—°ê²° íƒ€ì„ì•„ì›ƒ: 15ì´ˆ
- ì½ê¸° íƒ€ì„ì•„ì›ƒ: 25ì´ˆ

### ì—ëŸ¬ ì²˜ë¦¬
- API í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ "9999" ì½”ë“œê°€ ë°˜í™˜ë©ë‹ˆë‹¤.
- ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë‚˜ ì„œë²„ ì˜¤ë¥˜ì— ëŒ€ë¹„í•œ ì˜ˆì™¸ ì²˜ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.

## í…ŒìŠ¤íŠ¸ í™˜ê²½
ê°œë°œ ë° í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ì„œëŠ” ë‚˜ì´ìŠ¤í˜ì´ì—ì„œ ì œê³µí•˜ëŠ” í…ŒìŠ¤íŠ¸ ê³„ì • ì •ë³´ë¥¼ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤.

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ
- [ì¸ì¦ ê²°ì œ API ê°€ì´ë“œ (Auth)](https://developers.nicepay.co.kr/manual-auth.php)
- [ê²°ì œ í†µë³´ API (Notify)](https://developers.nicepay.co.kr/manual-noti.php)
- [ì •ê¸°ê²°ì œ ê¸°ëŠ¥ ì—°ë™ ë¬¸ì„œ (Subscribe)](https://github.com/nicepayments/nicepay-manual/wiki/subscribe-integration)

---
